import streamlit as st
import pandas as pd
import sqlite3
from pathlib import Path

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
# –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
DB_FILE = "database/journals.db"
st.set_page_config(page_title="–ü–æ–∏—Å–∫ –∂—É—Ä–Ω–∞–ª–æ–≤ –í–ê–ö", layout="wide")


# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º) ---

@st.cache_data
def convert_df_to_csv(df):
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç DataFrame –≤ CSV —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π UTF-8."""
    return df.to_csv(index=False).encode('utf-8')

@st.cache_data
def get_all_specialties():
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∞ "–ö–æ–¥ - –ù–∞–∑–≤–∞–Ω–∏–µ".
    """
    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute("SELECT code, name FROM specialties ORDER BY code")
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ "–ö–æ–¥ - –ù–∞–∑–≤–∞–Ω–∏–µ" –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        specialties_list = [f"{code} - {name}" for code, name in cursor.fetchall()]
        conn.close()
        return specialties_list
    except sqlite3.Error:
        return []

@st.cache_data
def find_journals_by_specialty(specialty_code):
    """
    –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∂—É—Ä–Ω–∞–ª—ã –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∫–æ–¥—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç pandas DataFrame.
    """
    conn = sqlite3.connect(DB_FILE)
    query = """
        SELECT
            j.title,
            j.issn,
            j.vak_category,
            j.scopus_indexed
        FROM
            journals j
        JOIN
            journal_specialties js ON j.id = js.journal_id
        JOIN
            specialties s ON js.specialty_id = s.id
        WHERE
            s.code = ?
        ORDER BY
            j.title;
    """
    df = pd.read_sql_query(query, conn, params=(specialty_code,))
    conn.close()
    return df


# --- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (Sidebar) ---
# st.sidebar.markdown("""
# ### Jurnalizer
# ... (–≤–µ—Å—å —Ç–µ–∫—Å—Ç –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ —É–¥–∞–ª–µ–Ω)
# """)


# --- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---

# –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ –≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.markdown(
    """
    <div style="background-color: #e8f0fe; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
    
    ### Jurnalizer
    –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –∂—É—Ä–Ω–∞–ª–æ–≤ –∏–∑ –ø–µ—Ä–µ—á–Ω—è –í–ê–ö.

    **–ê–≤—Ç–æ—Ä:** –†—É—Å—Ç–∞–º –ù–∞–∑–∏–ø–æ–≤  
    –ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º, –∞ —Ç–∞–∫–∂–µ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–µ–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–∏—à–∏—Ç–µ –≤ [Telegram](https://t.me/rustamnazipov).

    ---

    **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—É—á–Ω—ã—Ö –∂—É—Ä–Ω–∞–ª–æ–≤ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:**
    - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è –í–ê–ö:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ö1, –ö2, –ö3). –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ, —Å—Ç–∞–≤–∏—Ç—Å—è –ø–æ–º–µ—Ç–∫–∞ "–ö?".
    - **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ Scopus:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∂—É—Ä–Ω–∞–ª–∞ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–ø–∏—Å–∫–µ Scopus.

    **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:**
    - **–ü–µ—Ä–µ—á–µ–Ω—å –í–ê–ö –†–§:** –†–µ–¥–∞–∫—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–∑—ã.
    - **Scopus:** –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∂—É—Ä–Ω–∞–ª–æ–≤ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞ –∏—é–Ω—å 2025 –≥.
    
    </div>
    """,
    unsafe_allow_html=True
)


# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
if not Path(DB_FILE).exists():
    st.error(f"‚ùå **–û—à–∏–±–∫–∞:** –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö '{DB_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è.")
    st.info("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, —á—Ç–æ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.")
else:
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    specialties = get_all_specialties()

    if not specialties:
        st.warning("–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫.")
    else:
        # –°–æ–∑–¥–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–∏—Å–∫–∞
        placeholder = "-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∫–æ–¥/–Ω–∞–∑–≤–∞–Ω–∏–µ --"
        options = [placeholder] + specialties
        
        selected_option = st.selectbox(
            "–ù–∞—É—á–Ω–∞—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:",
            options,
            help="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '1.2.1') –∏–ª–∏ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ê–Ω–∞—Ç–æ–º–∏—è'), —á—Ç–æ–±—ã –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫."
        )

        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å (–∞ –Ω–µ placeholder)
        if selected_option != placeholder:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–¥ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ "–ö–æ–¥ - –ù–∞–∑–≤–∞–Ω–∏–µ"
            selected_code = selected_option.split(' - ')[0]

            # –ò—â–µ–º –∂—É—Ä–Ω–∞–ª—ã –∏ –≤—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            results_df = find_journals_by_specialty(selected_code)

            st.markdown("---") # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å

            if results_df.empty:
                st.info("‚ÑπÔ∏è –ü–æ –¥–∞–Ω–Ω–æ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∂—É—Ä–Ω–∞–ª—ã –≤ –±–∞–∑–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
            else:
                st.success(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ **{len(results_df)}** –∂—É—Ä–Ω–∞–ª(–æ–≤).")

                # --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
                # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
                results_df.rename(columns={
                    'title': '–ù–∞–∑–≤–∞–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞',
                    'issn': 'ISSN',
                    'vak_category': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –í–ê–ö',
                    'scopus_indexed': '–í Scopus'
                }, inplace=True)
                
                # –ó–∞–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è
                results_df['–í Scopus'] = results_df['–í Scopus'].apply(lambda x: '–î–∞' if x == 1 else '–ù–µ—Ç')
                results_df['–ö–∞—Ç–µ–≥–æ—Ä–∏—è –í–ê–ö'] = results_df['–ö–∞—Ç–µ–≥–æ—Ä–∏—è –í–ê–ö'].fillna('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')
                
                # –í—ã–≤–æ–¥–∏–º DataFrame –∫–∞–∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
                st.dataframe(results_df, use_container_width=True)

                # --- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ---
                csv_data = convert_df_to_csv(results_df)

                st.download_button(
                   label="üì• –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ CSV",
                   data=csv_data,
                   file_name=f'jurnalizer_{selected_code}.csv',
                   mime='text/csv',
                ) 